@page "/jenislesenmengikuttarikh"
@attribute [AllowAnonymous]


@using DevExpress.Blazor.Reporting
@using DevExpress.XtraReports.UI;
@using DevExpress.XtraReports.Parameters;
@using DevExpress.DataAccess.ConnectionParameters;
@using DevExpress.XtraReports.Expressions;
@using Parameter = DevExpress.XtraReports.Parameters.Parameter;

@using PBTPro.DAL.Models.PayLoads
@inject ReportService _ReportService
@inject RefLicenseTypeService _TypeService
@inject RefLicenseCatService _CategoryService
<link rel="stylesheet" href="_content/DevExpress.Blazor.Reporting.Viewer/css/dx-blazor-reporting-components.bs5.css">

<DxReportViewer @ref="reportViewer" Report="@Report">
</DxReportViewer>

@code {
    DxReportViewer? reportViewer { get; set; }
    XtraReport? Report { get; set; }


    protected override async Task OnInitializedAsync()
    {
        List<report_view> dtLesen = await _ReportService.ReportLesen();
        List<ref_license_type> dtJenisLesen = await _TypeService.ListAll();
        List<ref_license_cat> dtKategoriLesen = await _CategoryService.ListAll();

        //Bind to the report
        Report = new Reports.JenisLesenMengikutTarikh();


        //Set the report data source
        Report.DataSource = dtLesen.OrderBy(x => x.tarikh_mula);


        // Create a date range parameter.
        Parameter dateRangeParam = new Parameter();
        dateRangeParam.Name = "dateRange";
        dateRangeParam.Description = "Pilih Tarikh Mula / Tamat :";
        dateRangeParam.Type = typeof(System.DateTime);

        // Create a RangeParametersSettings instance and set up its properties.
        var dateRangeSettings = new RangeParametersSettings();

        // Specify the start date and end date parameters.
        dateRangeSettings.StartParameter.Name = "dateRangeStart";
        //dateRangeSettings.StartParameter.Description = "Tarikh Mula :";
        dateRangeSettings.StartParameter.ExpressionBindings.Add(
            new BasicExpressionBinding("Value", "AddYears(Today(), -1)"));

        dateRangeSettings.EndParameter.Name = "dateRangeEnd";
        //dateRangeSettings.EndParameter.Description = "Tarikh Tamat :";
        dateRangeSettings.EndParameter.ExpressionBindings.Add(
            new BasicExpressionBinding("Value", "AddYears(Today(), 0)"));

        // Assign the settings to the parameter's ValueSourceSettings property.
        dateRangeParam.ValueSourceSettings = dateRangeSettings;

        // Create a report instance and add the parameter to the report's Parameters collection.
        Report.Parameters.Add(dateRangeParam);


        // Create a 2nd report parameter.
        Parameter param2 = new Parameter();
        param2.Name = "lesen";
        param2.Description = "Lesen :";
        param2.Type = typeof(string);
        param2.MultiValue = false;

        // Create a DynamicListLookUpSettings instance and
        // set up its properties.
        var lookupSettings2 = new DynamicListLookUpSettings();
        lookupSettings2.DataSource = dtJenisLesen;
        lookupSettings2.ValueMember = "type_code";
        lookupSettings2.DisplayMember = "type_name";


        // Assign data storage settings to the parameter's ValueSourceSettings property.
        param2.ValueSourceSettings = lookupSettings2;
        // Set the parameter's Visible and SelectAllValues properties to true to
        // make the parameter visible in the Parameters Panel and select all
        // values as defaults.
        param2.Visible = true;
        param2.SelectAllValues = false;
        // Specify the parameter's default values.
        //////param.Value = new string[] { "Batu Pahat" };

        // Create a report instance and add the parameter to the report's Parameters collection.
        Report.Parameters.Add(param2);


        //--- Kategori ----
        // Create a report 3nd parameter.
        Parameter param3 = new Parameter();
        param3.Name = "kategori";
        param3.Description = "Kategori :";
        param3.Type = typeof(string);
        param3.MultiValue = true;

        // Create a DynamicListLookUpSettings instance and
        // set up its properties.
        var lookup3 = new DynamicListLookUpSettings();
        //////lookupDUN.UseServerSideFiltering = false;
        lookup3.DataSource = dtKategoriLesen;
        lookup3.ValueMember = "cat_code";
        lookup3.DisplayMember = "cat_name";

        // Assign data storage settings to the parameter's ValueSourceSettings property.
        param3.ValueSourceSettings = lookup3;

        // Specify the parameter's default values.
        param3.Value = new string[] { "" };

        // Set the parameter's Visible and SelectAllValues properties to true to
        // make the parameter visible in the Parameters Panel and select all
        // values as defaults.
        param3.Visible = true;
        param3.SelectAllValues = true;
        // Create a report instance and add the parameter to the report's Parameters collection.
        Report.Parameters.Add(param3);

        // if (dtLesen.Count > 0)
        // {
            Report.FilterString = "(((GetDate(tarikh_mula) >= (?dateRangeStart)) AND (GetDate(tarikh_tamat) <= (?dateRangeEnd))) AND ((?lesen <> 0 AND operasi_id In (?lesen)) AND (?kategori <> 0 AND kategori_id In (?kategori))))";
        // }

    }

}
