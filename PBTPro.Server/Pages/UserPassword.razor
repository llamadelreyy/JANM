@page "/user_password"
@attribute [AllowAnonymous]

@using PBTPro.Data
@using PBTPro.DAL.Models
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Components
@inject UserProfileService _UserProfileService
@inject DepartmentService _DepartmentService
@inject SectionService _SectionService
@inject UnitService _UnitService
@inject UserRoleService _UserRoleService
@inject PBTAuthStateProvider _PBTAuthStateProvider

@* @inject AllocationAuthenticationStateProvider AllocationAuthenticationStateProvider *@
@inject NavigationManager NavigationManager

<div class="d-lg-flex border-bottom">
    <div class="col-md-12 py-1 dx-helptitle pageTitle">
        <img class="imgTitle" src="/images/icons-small/card-address.png" />
        <div class="textTitle">Profail Pengguna (Katalaluan)</div>
    </div>
</div>

<div class="item-container-y">
    <div class="ProfileBox" style="border:solid 1px #999;border-radius: 5px;box-shadow: 0px 0px 12px rgba(0, 0, 0, 0.25);">
        <div class="card-body">
            <EditForm Model="@userPwd" OnValidSubmit="@HandleValidSubmit" OnInvalidSubmit="@HandleInvalidSubmit" Context="EditFormContext">
                <DataAnnotationsValidator />
                <DxFormLayout>
                    <DxFormLayoutItem ColSpanMd="5"></DxFormLayoutItem>
                    <DxFormLayoutItem ColSpanMd="2">
                        <div class="align-items-center align-content-center">
                            <img class="profile-photo" src="images/profile/avatar-user-profile-icon.jpg" alt="" />
                        </div>
                    </DxFormLayoutItem>
                    <DxFormLayoutItem ColSpanMd="5"></DxFormLayoutItem>

                    <DxFormLayoutItem ColSpanMd="12"><br /></DxFormLayoutItem>

                    <DxFormLayoutItem ColSpanMd="4">
                        <div>Jabatan</div>
                        <DxTextBox @bind-Text="@userInfo.profile_department_name"
                                   BindValueMode="BindValueMode.OnInput"
                                   CssClass="cw-480"
                                   Enabled="false" />
                    </DxFormLayoutItem>

                    <DxFormLayoutItem ColSpanMd="4">
                        <div>Section</div>
                        <DxTextBox @bind-Text="@userInfo.profile_section_name"
                                   BindValueMode="BindValueMode.OnInput"
                                   CssClass="cw-480"
                                   Enabled="false" />
                    </DxFormLayoutItem>

                    <DxFormLayoutItem ColSpanMd="4">
                        <div>Unit</div>
                        <DxTextBox @bind-Text="@userInfo.profile_unit_name"
                                   BindValueMode="BindValueMode.OnInput"
                                   CssClass="cw-480"
                                   Enabled="false" />
                    </DxFormLayoutItem>

                    <DxFormLayoutItem ColSpanMd="4">
                        <div>No Kad Pengenalan</div>
                        <DxTextBox @bind-Text="@userInfo.profile_icno"
                                   BindValueMode="BindValueMode.OnInput"
                                   CssClass="cw-480"
                                   Enabled="false" />
                    </DxFormLayoutItem>

                    <DxFormLayoutItem ColSpanMd="4">
                        <div>No Telefon</div>
                        <DxTextBox @bind-Text="@userInfo.profile_tel_no"
                                   BindValueMode="BindValueMode.OnInput"
                                   CssClass="cw-480"
                                   Enabled="false" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem ColSpanMd="4"></DxFormLayoutItem>

                    <DxFormLayoutItem ColSpanMd="4">
                        <div>ID Pengguna</div>
                        <DxTextBox @bind-Text="@userInfo.profile_user_id"
                                   BindValueMode="BindValueMode.OnInput"
                                   CssClass="cw-480"
                                   Enabled="false" />
                    </DxFormLayoutItem>

                    <DxFormLayoutItem ColSpanMd="4">
                        <div>Peranan</div>
                        <DxTextBox @bind-Text="@userInfo.profile_role"
                                   BindValueMode="BindValueMode.OnInput"
                                   CssClass="cw-480"
                                   Enabled="false" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem ColSpanMd="4"></DxFormLayoutItem>

                    <DxFormLayoutItem ColSpanMd="6">
                        <div>Nama</div>
                        <DxTextBox @bind-Text="@userInfo.profile_name"
                                   BindValueMode="BindValueMode.OnInput"
                                   CssClass="cw-480"
                                   Enabled="false" />
                    </DxFormLayoutItem>

                    <DxFormLayoutItem ColSpanMd="6">
                        <div>Emel</div>
                        <DxTextBox @bind-Text="@userInfo.profile_email"
                                   BindValueMode="BindValueMode.OnInput"
                                   CssClass="cw-480"
                                   Enabled="false" />
                    </DxFormLayoutItem>

                    <DxFormLayoutItem ColSpanMd="12"><hr /></DxFormLayoutItem>

                    <DxFormLayoutItem ColSpanMd="4">
                        <div>Katalaluan Lama</div>
                        <DxTextBox @bind-Text="@userPwd.userNowPassword"
                                   NullText="Katalaluan lama ..."
                                   BindValueMode="BindValueMode.OnInput"
                                   Enabled="true"
                                   Password="true"
                                   CssClass="cw-480"
                                   ShowValidationIcon="true"
                                   ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto" />
                    </DxFormLayoutItem>

                    <DxFormLayoutItem ColSpanMd="4">
                        <div>Katalaluan Baru</div>
                        <DxTextBox @bind-Text="@userPwd.userNewPassword"
                                   NullText="Katalaluan baru ..."
                                   BindValueMode="BindValueMode.OnInput"
                                   Enabled="true"
                                   Password="true"
                                   CssClass="cw-480"
                                   ShowValidationIcon="true"
                                   ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto" />
                    </DxFormLayoutItem>

                    <DxFormLayoutItem ColSpanMd="4">
                        <div>Sah Katalaluan Baru</div>
                        <DxTextBox @bind-Text="@userPwd.userConfirmPassword"
                                   NullText="Sahkan Katalaluan baru ..."
                                   BindValueMode="BindValueMode.OnInput"
                                   Enabled="true"
                                   Password="true"
                                   CssClass="cw-480"
                                   ShowValidationIcon="true" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem ColSpanMd="12"></DxFormLayoutItem>
                    <DxFormLayoutItem ColSpanMd="12">
                        <ul style="margin-top:-10px;">
                            <li>Min Kata Laluan mestilah 8 atau lebih aksara campuran huruf dan abjad.</li>
                            <li>Mesti mengandungi sekurang-kurangnya 1 huruf kecil dan 1 huruf besar abjad.</li>
                            <li>Mesti mengandungi sekurang-kurangnya 1 digit.</li>
                            <li>Mesti mengandungi sekurang-kurangnya 1 aksara khas. (cth:!#$%^&)</li>
                        </ul>
                        <DxButton CssClass="w-100 normal-btn" Text="Kemaskini Katalaluan"
                                  RenderStyle="ButtonRenderStyle.Primary"
                                  Enabled="true"
                                  SubmitFormOnClick="true">
                        </DxButton>
                    </DxFormLayoutItem>
                    @*                     <div>&nbsp;<br /></div>
                    <DxFormLayoutItem ColSpanMd="12">
                    <ValidationSummary />
                    </DxFormLayoutItem> *@
                </DxFormLayout>
                <div class="row w-100 mx-0">
                    <p class="demo-text col-12 mt-2">
                        Pengesahan Maklumat :
                        <b>@FormValidationState</b>
                    </p>
                </div>
            </EditForm>

        </div>
    </div>
</div>



@code {
    [Inject] IToastNotificationService ToastService { get; set; }
    user_profile userInfo = new user_profile();
    user_password userPwd = new user_password();

    IEnumerable<user_profile> dataSource;
    // IEnumerable<department_info> dtDepartment;
    // IEnumerable<section_info> dtSection;
    // IEnumerable<unit_info> dtUnit;
    // IEnumerable<user_role> dtRoles;

    //Get current user id
    int intCurrentUserId { get; set; } = 0;
    string FormValidationState = @"Sila tekan butang ""Simpan"" untuk sahkan data.";

    IEnumerable<char> PredefinedPlaceholders { get; set; } = new List<char>() { '_', '#' };
    // string EmailMask { get; set; } = @"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*";

    MaskAutoCompleteMode AutoCompleteMode { get; set; } = MaskAutoCompleteMode.Strong;
    char Placeholder { get; set; } = '_';
    bool PlaceholderVisible { get; set; } = true;

    TaskCompletionSource<bool> DataLoadedTcs { get; } = new(TaskCreationOptions.RunContinuationsAsynchronously);

    //============== Upload file ===============//
    int SelectedFilesCount { get; set; }
    protected void SelectedFilesChanged(IEnumerable<UploadFileInfo> files)
    {
        SelectedFilesCount = files.ToList().Count;
        InvokeAsync(StateHasChanged);
    }

    protected string GetUploadUrl(string url)
    {
        return NavigationManager.ToAbsoluteUri(url).AbsoluteUri;
    }
    //================ ** ==================//

    protected override async Task OnInitializedAsync()
    {
        dataSource = await _UserProfileService.Retrieve(_PBTAuthStateProvider.CurrentUser.Userid); //<-- temp comment for testing
        //dataSource = await _UserProfileService.Retrieve("1");
        if (dataSource != null)
        {
            userInfo = dataSource.FirstOrDefault();
            userPwd.userOldPassword = userInfo.userOldPassword;
        }

        // dtDepartment = await _DepartmentService.GetAllDepartment();
        // dtSection = await _SectionService.GetAllSection();
        // dtUnit = await _UnitService.GetAllUnit();
        // dtRoles = await _UserRoleService.GetRolesByUserAsync(_PBTAuthStateProvider.CurrentUser.Userid);

        DataLoadedTcs.TrySetResult(true);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await DataLoadedTcs.Task;
        }
    }

    public async Task HandleValidSubmit()
    {
        FormValidationState = @"Maklumat yang dimasukkan sah.";
        // bool blnSuccess = await _userService.UpdateUserPasswordAsync(userInfo, intCurrentUserId);

        // if (blnSuccess)
        // {
        //     toastService.ShowInfo("Proses kemaskini katalaluan selesai.");

        ToastService.ShowToast(new ToastOptions()
            {
                ProviderName = "Overview",
                ThemeMode = ToastThemeMode.Saturated,
                RenderStyle = ToastRenderStyle.Success,
                Title = "Proses kemaskini katalaluan selesai."
            });


        //     await AllocationAuthenticationStateProvider.LogoutAsync();
        //     //You actually need to NavigateTo your current Uri with force load. I use simple extension method for this
        //     NavigationManager.NavigateTo("login", true);

        // }
        // else
        // {

        //     ToastService.ShowToast(new ToastOptions()
        //         {
        //             ProviderName = "Overview",
        //             ThemeMode = ToastThemeMode.Saturated,
        //             RenderStyle = ToastRenderStyle.Danger,
        //             Title = "Ralat telah berlaku! Sila hubungi pentadbir sistem."
        //         });
        // //     toastService.ShowError("Ralat telah berlaku! Sila hubungi pentadbir sistem.");
        // }
    }

    void HandleInvalidSubmit()
    {
        FormValidationState = @"Maklumat yang dimasukkan tidak sah!";
    }

}
