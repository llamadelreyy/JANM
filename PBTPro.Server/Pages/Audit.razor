@page "/SenaraiAudit"
@attribute [AllowAnonymous]

@* @inject Services.AuditService _audit
@using DevExpress.Blazor
@implements IDisposable
@using Newtonsoft.Json
@using System.ComponentModel
@using PBTPro.DAL.Models;
 *@

 @using System.Globalization
@implements IDisposable
@using Blazored.Toast.Services
@using Newtonsoft.Json
@using System.ComponentModel
@using PBTPro.DAL.Models;
@using PBT.Data
@inject NavigationManager NavigationManager
@inject AuditService _audit
@inject IToastService toastService


<div class="d-lg-flex border-bottom mb-2">
    <div class="col-md-12 py-1 dx-helptitle pageTitle">
        <img class="imgTitle" src="/images/icons/information.png" />
        <div class="textTitle">Log Audit - Senarai Log Audit</div>
    </div>
</div>

<style>
    .dxbl-grid {
        height: 79vh;
        max-height: 79vh;
    }
</style>


<hr style="background-color:transparent; padding:0.5em 0;margin:auto;" />
<div class="item-container-x">
    <DxGrid @ref="Grid"
        Data="@_lstAudits" 
        KeyFieldName="AuditId"
        ShowGroupPanel="true"
        ShowFilterRow="true"
        FilterMenuButtonDisplayMode="GridFilterMenuButtonDisplayMode.Always"
        PageSize="25"
        @bind-PageIndex="@GridPageIndex"
        PagerPosition="GridPagerPosition.Bottom"
        PagerNavigationMode="PagerNavigationMode.InputBox"
        PageSizeSelectorVisible="true"
        PageSizeSelectorItems="@(new int[] { 25, 50, 100 })"
        PageSizeSelectorAllRowsItemVisible="true"
        PagerAutoHideNavButtons="false"
        ColumnResizeMode="@ColumnResizeMode"
        HighlightRowOnHover="true"
        CssClass="mv-1000">

        <Columns>
        <DxGridDataColumn FieldName="@nameof(AuditlogInfo.CreatedDate)" Caption="Tarikh Dicipta" TextAlignment="GridTextAlignment.Center" AllowGroup="false" />
        <DxGridDataColumn FieldName="@nameof(AuditlogInfo.AuditUsername)" Caption="Nama Pengguna" TextAlignment="GridTextAlignment.Left" AllowGroup="false" />
        <DxGridDataColumn FieldName="@nameof(AuditlogInfo.AuditType)" Caption="Jenis Maklumat" TextAlignment="GridTextAlignment.Center" AllowGroup="false" >
            <CellDisplayTemplate>
                <div>@GetStatusAuditIconHtml(((AuditlogInfo)context.DataItem).AuditType)</div>
            </CellDisplayTemplate>
        </DxGridDataColumn>
        <DxGridDataColumn FieldName="@nameof(AuditlogInfo.AuditModuleName)" Caption="Nama Modul" TextAlignment="GridTextAlignment.Left" AllowGroup="false" />
        <DxGridDataColumn FieldName="@nameof(AuditlogInfo.AuditMethod)" Caption="Method" TextAlignment="GridTextAlignment.Left" AllowGroup="false" />
        <DxGridDataColumn FieldName="@nameof(AuditlogInfo.AuditDescription)" Caption="Penerangan" TextAlignment="GridTextAlignment.Left" AllowGroup="false" />
        </Columns>      
    </DxGrid>
    <hr style="background-color:transparent; border: 2px solid #FFF;padding:0;margin:auto;" />
    <DxButton Text="Export XLSX" Click="ExportXlsx_Click" />
    <DxButton Text="Export XLS" Click="ExportXls_Click" />
    <DxButton Text="Export CSV" Click="ExportCsv_Click" />
    <DxButton Text="Archive Audit Log within 6 months data" Click="InsertArchiveAudit_Click" />
    <hr style="background-color:transparent; padding:0.5em 0;margin:auto;" />
</div>
@code {

    private List<AuditlogInfo> _lstAudits = new List<AuditlogInfo>();

    IGrid Grid { get; set; }
    int GridPageIndex { get; set; } = 0;
    string GridSearchText = "";

    bool ConfirmationShown { get; set; } = false;
    string strSelected { get; set; }
    int intSelected { get; set; }
    AuditlogInfo dtData { get; set; }

    GridColumnResizeMode ColumnResizeMode { get; set; } = GridColumnResizeMode.ColumnsContainer;
    TaskCompletionSource<bool> DataLoadedTcs { get; } = new(TaskCreationOptions.RunContinuationsAsynchronously);


    protected override async Task OnInitializedAsync()
    {
        _lstAudits = await _audit.GetAuditAsync();
        DataLoadedTcs.TrySetResult(true);

        try
        {
            _lstAudits = await _audit.GetAllAudit();
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error loading actions: {ex.Message}");
        }
    }  
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await DataLoadedTcs.Task;
            await Grid.CancelEditAsync();
        }
    }

    void Grid_CustomizeDataRowEditor(GridCustomizeDataRowEditorEventArgs e)
    {
        if (e.EditSettings is ITextEditSettings settings)
            settings.ShowValidationIcon = true;
    }
    public void Dispose()
    {
        DataLoadedTcs.TrySetCanceled();
    }
    public MarkupString GetStatusAuditIconHtml(int? status)
    {
        string priorytyClass = "";
        string title = "";

        if (status == 2)
        {
            priorytyClass = "info";
            title = " Informasi ";
        }
        else if (status == 1)
        {
            priorytyClass = "danger";
            title = " Ralat ";
        }

        string html = string.Format("<span class='badge priority-{0} py-1 px-2' title='{1}'>{1}</span>", priorytyClass,
        title);
        return new MarkupString(html);
    }

    async Task ExportXlsx_Click()
    {
        await Grid.ExportToXlsxAsync("ExportResult");
    }

    async Task ExportXls_Click()
    {
        await Grid.ExportToXlsAsync("ExportResult");
    }

    async Task ExportCsv_Click()
    {
        await Grid.ExportToCsvAsync("ExportResult");
    }
    async Task InsertArchiveAudit_Click()
    {
        await _audit.InsertArchiveAudit();
    }
}
