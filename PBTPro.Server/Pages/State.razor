@page "/state"
@attribute [Authorize]

@implements IDisposable

@using PBTPro
@using PBTPro.Shared
@using PBTPro.Data
@using PBTPro.DAL
@using PBTPro.DAL.Models
@using PBTPro.DAL.Services
@using PBTPro.DAL.Models.CommonServices

@inject CountryService _CountryService
@inject StateService _StateService
@inject NavigationManager NavigationManager
@inject PBTAuthStateProvider _PBTAuthStateProvider
@inject IToastNotificationService ToastService
@inject PBTAuthPermissionService PermissionService

<style>
    .dxbl-grid {
        height: 98.5%;
        max-height: 98.5%;
    }
</style>
@if (!PermissionService.HasPermission("View"))
{
    NavigationManager.NavigateTo("/no-permission");
}
else
{
    <DxLoadingPanel @bind-Visible="PanelVisible"
                    IsContentBlocked="true"
                    ApplyBackgroundShading="true"
                    IndicatorAreaVisible="false"
                    Text="Capaian Data...">

        <div class="d-lg-flex border-bottom">
            <div class="col-md-12 py-1 dx-helptitle pageTitle">
                <img class="imgTitle" src="\images\icons-small\hard-hat--plus.png" />
                <div class="textTitle">Seksyen</div>
            </div>
        </div>

        <div class="item-container-x">
            <DxGrid @ref="Grid"
                    Data="dataSource"
                    KeyFieldName="state_id"
                    ShowGroupPanel="true"
                    ShowFilterRow="false"
                    TextWrapEnabled="true"
                    CustomizeSummaryDisplayText="Grid_CustomizeSummaryDisplayText"
                    EditorRenderMode="GridEditorRenderMode.Integrated"
                    FilterMenuButtonDisplayMode="GridFilterMenuButtonDisplayMode.Always"
                    ShowSearchBox="true"
                    AllowSelectRowByClick="true"
                    @bind-SearchText="@GridSearchText"
                    PageSize="25"
                    @bind-PageIndex="@GridPageIndex"
                    PagerPosition="GridPagerPosition.Bottom"
                    PagerNavigationMode="PagerNavigationMode.InputBox"
                    EditModelSaving="Grid_EditModelSaving"
                    EditFormButtonsVisible="false"
                    PageSizeSelectorVisible="true"
                    PageSizeSelectorItems="@(new int[] { 25, 50, 100 })"
                    PageSizeSelectorAllRowsItemVisible="true"
                    PagerAutoHideNavButtons="false"
                    ColumnResizeMode="GridColumnResizeMode.ColumnsContainer"
                    GroupFooterDisplayMode="GridGroupFooterDisplayMode.Auto"
                    HighlightRowOnHover="true"
                    CssClass="mv-1000">

                <Columns>
                    <DxGridCommandColumn Width="55px">
                        <HeaderTemplate>
                            @if (PermissionService.HasPermission("Add"))
                            {
                                <a @onclick="@(() => Grid.StartEditNewRowAsync())" style="text-decoration: none;" href="javascript:void(0);"><img src="images/icons/plus-circle.png" /></a>
                            }
                        </HeaderTemplate>
                        <CellDisplayTemplate>
                            @if (PermissionService.HasPermission("Edit"))
                            {
                                <a @onclick="@(() => Grid.StartEditRowAsync(context.VisibleIndex))" style="text-decoration: none; padding:0px 2px;" href="javascript:void(0);"><img src="images/icons-small/table--pencil.png" /></a>
                            }
                            @if (PermissionService.HasPermission("Delete"))
                            {
                                <a @onclick="@(() => Delete((mst_state)context.DataItem))" style="text-decoration: none;padding:0px 0px 0px 2px;" href="javascript:void(0);"><img src="images/icons-small/cross-circle-frame.png" /></a>
                            }
                        </CellDisplayTemplate>
                    </DxGridCommandColumn>
                    <DxGridDataColumn Caption="Negara" MinWidth="120" Width="30%" FieldName="country_name" />
                    <DxGridDataColumn Caption="Kod" MinWidth="100" Width="20%" FieldName="state_code" />
                    <DxGridDataColumn Caption="Nama" MinWidth="250" Width="38%" FieldName="state_name" TextAlignment="GridTextAlignment.Left" />

                    <DxGridDataColumn FieldName="created_at"
                                      DisplayFormat="dd/MM/yyyy"
                                      Caption="Tarikh Data"
                                      MinWidth="100"
                                      Width="12%"
                                      TextAlignment="GridTextAlignment.Center"
                                      SortOrder="GridColumnSortOrder.Ascending"
                                      SortIndex="0">
                        <FilterMenuTemplate>
                            <DateRange FilterContext="context" />
                        </FilterMenuTemplate>
                    </DxGridDataColumn>
                </Columns>

                <EditFormTemplate Context="EditFormContext">
                    @{
                        var dtEdit = (mst_state)EditFormContext.EditModel;
                    }
                    <DxFormLayout CssClass="w-100">
                        <DxFormLayoutItem ColSpanMd="4" BeginRow="true">
                            <table class="layout_edit">
                                <tr>
                                    <td nowrap>Negara</td>
                                    <td nowrap>&nbsp;&nbsp;</td>
                                    <td width="50%" colspan="6">
                                        <DxComboBox Data="@dtCountry"
                                                    NullText="Pilih Negara ..."
                                                    ShowValidationIcon="true"
                                                    FilteringMode="DataGridFilteringMode.Contains"
                                                    @bind-Value="@dtEdit.country_code"
                                                    @bind-Text="@dtEdit.country_name"
                                                    TextFieldName="country_name"
                                                    ValueFieldName="country_code"
                                                    CssClass="cw-320" style="width:300px">
                                        </DxComboBox>
                                    </td>
                                </tr>
                                <tr>
                                    <td nowrap>Kod</td>
                                    <td nowrap>&nbsp;&nbsp;</td>
                                    <td width="50%">
                                        <DxTextBox @bind-Text="@dtEdit.state_code"
                                                   ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                                                   BindValueMode="BindValueMode.OnInput"
                                                   NullText="Kod negeri ..."
                                                   Maxlength="10"
                                                   ShowValidationIcon="true"
                                                   CssClass="cw-320" style="width:120px" />
                                    </td>
                                    <td width="100px">&nbsp;</td>
                                    <td nowrap></td>
                                    <td>&nbsp;&nbsp;</td>
                                    <td width="50%"></td>
                                </tr>
                                <tr>
                                    <td nowrap>Nama</td>
                                    <td nowrap>&nbsp;&nbsp;</td>
                                    <td width="50%" colspan="6">
                                        <DxTextBox @bind-Text="@dtEdit.state_name"
                                                   ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                                                   BindValueMode="BindValueMode.OnInput"
                                                   NullText="Masukkan nama negeri ..."
                                                   Maxlength="60"
                                                   ShowValidationIcon="true"
                                                   CssClass="cw-320" style="width:300px" />
                                    </td>
                                </tr>
                            </table>
                        </DxFormLayoutItem>
                        <DxFormLayoutItem ColSpanMd="12"><hr style="padding:0;margin:0;" /></DxFormLayoutItem>
                        <DxFormLayoutItem ColSpanMd="12">
                            <DxButton SubmitFormOnClick="true" class="btn-edit-grid" Text="Simpan" />
                            <DxButton Click="@(() => Grid.CancelEditAsync())" class="btn-edit-grid" Text="Batal" />
                        </DxFormLayoutItem>
                    </DxFormLayout>
                </EditFormTemplate>
                <CustomValidators>
                    <MyCustomValidator DataItemValidating="ValidateGridData" />
                </CustomValidators>


                <TotalSummary>
                    <DxGridSummaryItem FooterColumnName="state_code"
                                       Name="Custom"
                                       SummaryType=GridSummaryItemType.Count />
                </TotalSummary>

            </DxGrid>

        </div>
    </DxLoadingPanel>

    <DxPopup @bind-Visible="@ConfirmationShown" HeaderText="Hapus rekod" CssClass="confirmation-header" Width="auto" CloseOnOutsideClick="false">
        <BodyContentTemplate>
            <b>@strSelected</b> --> adalah rekod yang dipilih untuk dihapuskan.
            <br />Anda pasti untuk menghapuskan rekod ini?
            <br /><br />
            <div class="confirm-dialog-buttons">
                <DxButton Text="Ya" RenderStyle="ButtonRenderStyle.Primary" class="confirmation-btn" Click="@OnYesButtonClick" />
                <DxButton Text="Tidak" RenderStyle="ButtonRenderStyle.Secondary" class="confirmation-btn" Click="@OnNoButtonClick" />
            </div>
        </BodyContentTemplate>
    </DxPopup>
}

@code {
    bool PanelVisible { get; set; }
    IEnumerable<mst_country> dtCountry;
    IEnumerable<mst_state> dataSource;

    IGrid Grid { get; set; }
    int GridPageIndex { get; set; } = 0;
    string GridSearchText = "";

    bool ConfirmationShown { get; set; } = false;
    string strSelected { get; set; }
    mst_state dtData { get; set; }

    TaskCompletionSource<bool> DataLoadedTcs { get; } = new(TaskCreationOptions.RunContinuationsAsynchronously);

    protected override async Task OnInitializedAsync()
    {
        PanelVisible = true;
        dataSource = await _StateService.ListAll();
        dtCountry = await _CountryService.ListAll();

        DataLoadedTcs.TrySetResult(true);
        PanelVisible = false;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await DataLoadedTcs.Task;
            await Grid.CancelEditAsync(); //.StartEditRowAsync(0);
        }
    }

    void ValidateGridData(ValidationMessageStoreEventArgs e)
    {
        var _data = (mst_state)e.EditModel;

        if (_data.state_code == null || _data.state_code.Trim() == "")
        {
            e.AddError(nameof(_data.state_code), "Medan kod negeri perlu diisi.");
        }

        if (_data.state_name == null || _data.state_name.Trim() == "")
        {
            e.AddError(nameof(_data.state_name), "Medan nama negeri perlu diisi.");
        }

        if (_data.country_code == null || _data.country_code.Trim() == "")
        {
            e.AddError(nameof(_data.country_code), "Sila pilih negara dari senarai.");
        }

        if (Grid.IsEditingNewRow())
        {
            var _dtAdd = dataSource.Where(x => x.country_code == _data.country_code && x.state_code == _data.state_code).FirstOrDefault();

            if (_dtAdd != null)
                e.AddError(nameof(_data.state_code), "Kod negeri telah wujud.");
        }
        else
        {
            var _dtEdit = dataSource.Where(x => x.country_code == _data.country_code && x.state_id != _data.state_id && x.state_code == _data.state_code).FirstOrDefault();

            if (_dtEdit != null)
                e.AddError(nameof(_data.state_code), "Kod negeri telah wujud.");
        }

    }

    async Task Grid_EditModelSaving(GridEditModelSavingEventArgs e)
    {

        ReturnViewModel response = new ReturnViewModel();
        var editModel = e.EditModel as mst_state;

        try
        {
            if (e.IsNew)
                response = await _StateService.Add(editModel);
            else
                response = await _StateService.Update(editModel.state_id, editModel);


            if (response.ReturnCode == 200)
            {
                await UpdateDataAsync();
                HandleResponse("Proses kemaskini selesai.");
            }
            else
            {
                HandleResponse(response.ReturnMessage, "Error");
            }
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"An error occurred while saving the edit model: {ex.Message}");
        }
    }

    async Task UpdateDataAsync()
    {
        //Refresh back the data source
        dataSource = await _StateService.Refresh();
    }

    public void Dispose()
    {
        DataLoadedTcs.TrySetCanceled();
    }

    async Task Delete(mst_state item)
    {
        strSelected = item.state_code + " - " + item.state_name;
        dtData = item;
        ConfirmationShown = true;
    }

    async void OnYesButtonClick()
    {
        try
        {
            ReturnViewModel response = new ReturnViewModel();
            response = await _StateService.Delete(dtData.state_id);

            if (response.ReturnCode == 200)
            {
                await UpdateDataAsync();
                ConfirmationShown = false;
                StateHasChanged();
                HandleResponse(response.ReturnMessage);
            }
            else
            {
                ConfirmationShown = false;
                HandleResponse(response.ReturnMessage, "Error");
            }
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"An error occurred while delete the edit model: {ex.Message}");
        }
    }

    void OnNoButtonClick()
    {
        ConfirmationShown = false;
    }

    void Grid_CustomizeSummaryDisplayText(GridCustomizeSummaryDisplayTextEventArgs e)
    {
        if (e.Item.Name == "Custom")
            e.DisplayText = string.Format("Bil. : {0}", e.Value);
    }


    #region response
    private void HandleResponse(string message, string? status = "Success")
    {
        var RenderStyle = ToastRenderStyle.Success;

        if (status == "Error")
        {
            RenderStyle = ToastRenderStyle.Danger;
        }
        else if (status == "Info")
        {
            RenderStyle = ToastRenderStyle.Info;
        }
        else if (status == "Warning")
        {
            RenderStyle = ToastRenderStyle.Warning;
        }

        ToastService.ShowToast(new ToastOptions()
            {
                ProviderName = "Overview",
                ThemeMode = ToastThemeMode.Saturated,
                RenderStyle = RenderStyle,
                Title = message
            });
    }
    #endregion

}