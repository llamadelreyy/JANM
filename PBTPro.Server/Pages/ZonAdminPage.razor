@page "/zon_Admin" 
@attribute [Authorize]

@implements IDisposable

@using PBTPro
@using PBTPro.Shared
@using PBTPro.Data
@using PBTPro.DAL
@using PBTPro.DAL.Models
@using PBTPro.DAL.Services
@using PBTPro.DAL.Models.CommonServices
@using DevExpress.Blazor
@using PBTPro.DAL.Models.PayLoads

@inject DashboardService _DashboardService
@inject NavigationManager NavigationManager
@inject PBTAuthPermissionService PermissionService
@inject IToastNotificationService ToastService

<DxLoadingPanel @bind-Visible="PanelVisible"
                IsContentBlocked="true"
                ApplyBackgroundShading="true"
                IndicatorAreaVisible="false"
                Text="Capaian Data...">

    <div class="d-lg-flex border-bottom">
        <div class="col-md-12 py-1 dx-helptitle pageTitle">
            <img class="imgTitle" src="/images/icons-small/information-frame.png" />
            <div class="textTitle">Ringkasan Eksekutif</div>
        </div>
    </div>

    @if (!PermissionService.HasPermission("View"))
    {
        NavigationManager.NavigateTo("/no-permission");
    }
    else
    {
        <div class="item-container-y">
            <div class="d-lg-flex" style="padding:0 0 0 0;">
                <div class="d-lg-flex col-12">

                    <div class="col-3 dashboard-box">
                        <div class="dashboard-style notis-color">
                            <div class="dashboard-wrap">
                                <p class="dashboard-center-text">
                                    <span class="totalinnumber">@dtSource.total_notis</span>
                                    <span class="totalinword">Notis</span>
                                </p>
                            </div>
                            <div class="dashboard-button">
                                <a href="jumlesenaktif" class="round-button">...</a>
                            </div>
                        </div>
                    </div>

                    <div class="col-3 dashboard-box">
                        <div class="dashboard-style kompaun-color">
                            <div class="dashboard-wrap">
                                <p class="dashboard-center-text">
                                    <span class="totalinnumber">@dtSource.total_kompaun</span>
                                    <span class="totalinword">Kompaun</span>
                                </p>
                            </div>
                            <div class="dashboard-button">
                                <a href="jumlesenaktif" class="round-button">...</a>
                            </div>
                        </div>
                    </div>

                    <div class="col-3 dashboard-box">
                        <div class="dashboard-style nota-color">
                            <div class="dashboard-wrap">
                                <p class="dashboard-center-text">
                                    <span class="totalinnumber">@dtSource.total_inspection</span>
                                    <span class="totalinword">Nota pemeriksaan</span>
                                </p>
                            </div>
                            <div class="dashboard-button">
                                <a href="jumlesenaktif" class="round-button">...</a>
                            </div>
                        </div>
                    </div>

                    <div class="col-3 dashboard-box">
                        <div class="dashboard-style sitaan-color">
                            <div class="dashboard-wrap">
                                <p class="dashboard-center-text">
                                    <span class="totalinnumber">@dtSource.total_confiscation</span>
                                    <span class="totalinword">Sitaan</span>
                                </p>
                            </div>
                            <div class="dashboard-button">
                                <a href="jumlesenaktif" class="round-button">...</a>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <div class="d-lg-flex" style="padding:0 0 0 0;">
                <div class="d-lg-flex col-12">

                    <div class="col-6 dashboard-box">
                        <div class="dashboard-style-big big-color">
                            <div class="dashboard-wrap">
                                <p /><p /><p />
                                <p class="dashboard-center-text">
                                    <span class="totalinnumber">@dtSource.premis_berlesen</span>
                                    <span class="totalinword">Jumlah Premis Berlesen</span>
                                </p>
                                <p /><p /><p />
                            </div>
                            <div class="dashboard-button">
                                <a href="jumlesenaktif" class="round-button">...</a>
                            </div>
                        </div>
                    </div>

                    <div class="col-6 dashboard-box">
                        <div class="dashboard-style-big big-color">
                            <div class="dashboard-wrap">
                                <p class="dashboard-center-text">
                                    <span class="totalinnumber">@dtSource.premis_tamat_tempoh_lesen</span>
                                    <span class="totalinword">Jumlah Premis Tidak Berlesen</span>
                                </p>
                            </div>
                            <div class="dashboard-button">
                                <a href="jumlesenaktif" class="round-button">...</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="d-lg-flex" style="padding:0 0 0 0;">
                <div class="d-lg-flex col-12">

                    <div class="col-6 dashboard-box">
                        <div class="dashboard-style-big big-color">
                            <div class="dashboard-wrap">
                                <p /><p /><p />
                                <p class="dashboard-center-text">
                                    <span class="totalinnumber">@dtSource.premis_diperiksa</span>
                                    <span class="totalinword">Jumlah Premis DiPeriksa</span>
                                </p>
                                <p /><p /><p />
                            </div>
                            <div class="dashboard-button">
                                <a href="jumlesenaktif" class="round-button">...</a>
                            </div>
                        </div>
                    </div>

                    <div class="col-6 dashboard-box">
                        <div class="dashboard-style-big big-color">
                            <div class="dashboard-wrap">
                                <p class="dashboard-center-text">
                                    <span class="totalinnumber">@dtSource.premis_dikenakan_tindakan</span>
                                    <span class="totalinword">Jumlah Premis Dikenakan Tindakan</span>
                                </p>
                            </div>
                            <div class="dashboard-button">
                                <a href="jumlesenaktif" class="round-button">...</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    }
</DxLoadingPanel>

@code {
    bool PanelVisible { get; set; }
    dashboard_view dtSource = new dashboard_view();

    TaskCompletionSource<bool> DataLoadedTcs { get; } = new(TaskCreationOptions.RunContinuationsAsynchronously);

    protected override async Task OnInitializedAsync()
    {
        PanelVisible = true;
        if (dtSource != null)
            dtSource = await _DashboardService.GetDashboardData();

        DataLoadedTcs.TrySetResult(true);
        PanelVisible = false;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await DataLoadedTcs.Task;
        }
    }

    public void Dispose()
    {
        DataLoadedTcs.TrySetCanceled();
    }

}