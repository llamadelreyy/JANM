@page "/senarai_arkib"
@attribute [Authorize(Roles = "Administrator")]

@implements IDisposable

@using System.Globalization
@using Blazored.Toast.Services
@using Newtonsoft.Json
@using System.ComponentModel
@using PBTPro.DAL.Models;
@using PBTPro.Data
@using PBTPro.DAL.Models.CommonServices
@using PBTPro.DAL.Services

@inject ArchiveAuditService _audit
@inject PBTAuthStateProvider _PBTAuthStateProvider
@inject IToastNotificationService ToastService
@inject NavigationManager NavigationManager
@inject IToastService toastService


<div class="d-lg-flex border-bottom mb-2">
    <div class="col-md-12 py-1 dx-helptitle pageTitle">
        <img class="imgTitle" src="/images/icons/information.png" />
        <div class="textTitle">Log Audit - Senarai Arkib Log Audit</div>
    </div>
</div>

<style>
    .dxbl-grid {
        height: 79vh;
        max-height: 79vh;
    }
</style>


<hr style="background-color:transparent; padding:0.5em 0;margin:auto;" />
<div class="item-container-x">
    <DxGrid @ref="Grid"
        Data="@_lstAudits" 
        KeyFieldName="ArchiveId"
        ShowGroupPanel="true"
        ShowFilterRow="true"
        FilterMenuButtonDisplayMode="GridFilterMenuButtonDisplayMode.Always"
        PageSize="25"
        @bind-PageIndex="@GridPageIndex"
        PagerPosition="GridPagerPosition.Bottom"
        PagerNavigationMode="PagerNavigationMode.InputBox"
        PageSizeSelectorVisible="true"
        PageSizeSelectorItems="@(new int[] { 25, 50, 100 })"
        PageSizeSelectorAllRowsItemVisible="true"
        PagerAutoHideNavButtons="false"
        ColumnResizeMode="@ColumnResizeMode"
        HighlightRowOnHover="true"
        CssClass="mv-1000">

        <Columns>
            <DxGridDataColumn FieldName="@nameof(auditlog_archive_info.created_date)" Caption="Tarikh Dicipta" TextAlignment="GridTextAlignment.Center" AllowGroup="false" />
            <DxGridDataColumn FieldName="@nameof(auditlog_archive_info.archive_username)" Caption="Nama Pengguna" TextAlignment="GridTextAlignment.Left" AllowGroup="false" />
            <DxGridDataColumn FieldName="@nameof(auditlog_archive_info.archive_type)" Caption="Jenis Maklumat" TextAlignment="GridTextAlignment.Center" AllowGroup="false">
            <CellDisplayTemplate>
                    <div>@GetStatusAuditIconHtml(((auditlog_archive_info)context.DataItem).archive_type)</div>
            </CellDisplayTemplate>
        </DxGridDataColumn>
            <DxGridDataColumn FieldName="@nameof(auditlog_archive_info.archive_module_name)" Caption="Nama Modul" TextAlignment="GridTextAlignment.Left" AllowGroup="false" />
            <DxGridDataColumn FieldName="@nameof(auditlog_archive_info.archive_method)" Caption="Method" TextAlignment="GridTextAlignment.Left" AllowGroup="false" />
            <DxGridDataColumn FieldName="@nameof(auditlog_archive_info.archive_description)" Caption="Penerangan" TextAlignment="GridTextAlignment.Left" AllowGroup="false" />
        </Columns>      
    </DxGrid>
    <hr style="background-color:transparent; border: 2px solid #FFF;padding:0;margin:auto;" />
<hr style="background-color:transparent; padding:0.5em 0;margin:auto;" />
</div>

@code {
    private List<auditlog_archive_info> _lstAudits = new List<auditlog_archive_info>();
    auditlog_archive_info dtData { get; set; }
    IGrid Grid { get; set; }
    int GridPageIndex { get; set; } = 0;

    GridColumnResizeMode ColumnResizeMode { get; set; } = GridColumnResizeMode.ColumnsContainer;
    TaskCompletionSource<bool> DataLoadedTcs { get; } = new(TaskCreationOptions.RunContinuationsAsynchronously);

    #region list
    protected override async Task OnInitializedAsync()
    {
        _lstAudits = await _audit.GetAuditAsync();
        try
        {
            _lstAudits = await _audit.ListAll();
        }
        catch (Exception ex)
        {
        }
        DataLoadedTcs.TrySetResult(true);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await DataLoadedTcs.Task;
            await Grid.CancelEditAsync();
        }
    }
    #endregion

    #region lookup
    public MarkupString GetStatusAuditIconHtml(int? status)
    {
        string priorytyClass = "";
        string title = "";

        if (status == 2)
        {
            priorytyClass = "info";
            title = " INFORMASI ";
        }
        else if (status == 1)
        {
            priorytyClass = "danger";
            title = " RALAT ";
        }

        string html = string.Format("<span class='badge priority-{0} py-1 px-2' title='{1}'>{1}</span>", priorytyClass,
        title);
        return new MarkupString(html);
    }
    #endregion

    public void Dispose()
    {
        DataLoadedTcs.TrySetCanceled();
    }

}
